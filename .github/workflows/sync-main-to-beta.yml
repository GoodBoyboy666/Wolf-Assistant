name: Sync Main to Beta

# 触发条件：当 main 分支有代码 push 时（包括合并 PR 进 main）
on:
  push:
    branches:
      - main

jobs:
  sync-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: beta
          fetch-depth: 0
          token: ${{ secrets.ACTION_TOKEN }}

      - name: Merge Main into Beta
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTION_TOKEN }}
          script: |
            try {
              // 获取 main 分支的最新 SHA
              const { data: headRef } = await github.rest.git.getRef({
                owner,
                repo,
                ref: `heads/${headBranch}`,
              });
              const headSha = headRef.object.sha;

              console.log(`Target (Main) SHA: ${headSha}`);

              // 尝试执行 Fast-Forward
              try {
                await github.rest.git.updateRef({
                  owner,
                  repo,
                  ref: `heads/${baseBranch}`,
                  sha: headSha,
                  force: false
                });
                console.log('✅ Fast-forward successful! No new commit created.');
                return; // 如果成功，直接结束
              } catch (ffError) {
                console.log('ℹ️ Fast-forward not possible (branches diverged). Falling back to Merge.');
              }

              // 执行标准合并
              const mergeResult = await github.rest.repos.merge({
                owner,
                repo,
                base: baseBranch,
                head: headBranch,
                commit_message: 'Sync main to beta (Automated merge)'
              });
              console.log('✅ Merge successful with commit:', mergeResult.data.commit.sha);

            } catch (error) {
              if (error.status === 409) {
                 console.log('⚠️ Merge Conflict! Manual intervention required.');
                 core.setFailed('Merge conflict detected.');
              } else {
                 console.log('❌ Error:', error.message);
                 core.setFailed(error.message);
              }
            }

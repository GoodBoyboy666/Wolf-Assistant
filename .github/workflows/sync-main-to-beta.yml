name: Sync Main to Beta

# 触发条件：当 main 分支有代码 push 时（包括合并 PR 进 main）
on:
  push:
    branches:
      - main

jobs:
  sync-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: beta
          fetch-depth: 0
          token: ${{ secrets.ACTION_TOKEN }}

      - name: Merge Main into Beta
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ACTION_TOKEN }}
          script: |
            try {
              const result = await github.rest.repos.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: 'beta',
                head: 'main',
                commit_message: 'Sync main to beta (Automated merge)'
              });
              console.log('✅ Merge successful:', result.data.commit.sha);
            } catch (error) {
              if (error.status === 409) {
                console.log('⚠️ Merge Conflict Detected! Manual intervention required.');
                process.exit(1);
              } else {
                console.log('❌ Unexpected error:', error.message);
                throw error;
              }
            }

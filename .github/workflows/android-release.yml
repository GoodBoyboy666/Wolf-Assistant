name: Android Release Publisher

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
jobs:
  build-and-release:
    name: Build and Release APK
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # è®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # è®¾ç½® Gradle ç¯å¢ƒ
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # æ„å»º Keystore
      - name: Decode Keystore
        id: decode_keystore
        uses: timheuer/base64-to-file@v1.2
        with:
          fileName: 'release.keystore'
          encodedString: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}

      # è®¾ç½®æ‰§è¡Œæƒé™
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # å¼€å§‹æ„å»º
      - name: Build with Gradle
        run: ./gradlew assembleGithubActionRelease
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEYSTORE_PATH: ${{ steps.decode_keystore.outputs.filePath }}

      # è·å–é¡¹ç›®åä¸ç‰ˆæœ¬
      - name: Get project and version names
        id: get_names
        run: |
          echo "project_name=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
          echo "version_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      # æŸ¥æ‰¾æ„å»ºçš„ APK æ–‡ä»¶
      - name: Find and Rename APK
        id: find_apk
        run: |
          APK_DIR="app/build/outputs"
          APK_PATH=$(find "$APK_DIR" -type f -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "::error::Release APK not found!"
            exit 1
          fi
          NEW_APK_NAME="${{ steps.get_names.outputs.project_name }}-${{ steps.get_names.outputs.version_name }}.apk"
          echo "âœ… Found APK at $APK_PATH"
          mv "$APK_PATH" "$NEW_APK_NAME"
          echo "ğŸ‰ Renamed to $NEW_APK_NAME"
          echo "apk_path=$NEW_APK_NAME" >> $GITHUB_OUTPUT

      # æŸ¥æ‰¾ Mapping æ–‡ä»¶
      - name: Find Mapping File
        id: find_mapping
        run: |
          MAPPING_DIR="app/build/outputs"
          MAPPING_PATH=$(find "$MAPPING_DIR" -type f -name "mapping.txt" | head -n 1)
          if [ ! -f "$MAPPING_PATH" ]; then
            echo "::warning::mapping.txt not found!"
            echo "mapping_path=" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found mapping file at $MAPPING_PATH"
            echo "mapping_path=$MAPPING_PATH" >> $GITHUB_OUTPUT
          fi

      # ç”Ÿæˆ Release å†…å®¹
      - name: Get Release Body from Git Tag
        id: get_release_body
        run: |
          git tag -l --format='%(contents)' ${{ github.ref_name }} > release_notes.md
          echo "path=release_notes.md" >> $GITHUB_OUTPUT

      # åˆ¤æ–­æ˜¯å¦ä¸ºéæ­£å¼ç‰ˆæœ¬
      - name: Determine Release Type
        id: determine_release_type
        run: |
          # æ£€æŸ¥ tag æ˜¯å¦åŒ…å« beta, rc, preview, alpha ç­‰å…³é”®å­—
          if [[ "${{ github.ref_name }}" == *"-beta"* || "${{ github.ref_name }}" == *"-rc"* || "${{ github.ref_name }}" == *"-preview"* || "${{ github.ref_name }}" == *"-alpha"* ]]; then
            echo "This is a pre-release."
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "is_draft=false" >> $GITHUB_OUTPUT
          else
            echo "This is a stable release."
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "is_draft=true" >> $GITHUB_OUTPUT
          fi

      # å‘å¸ƒç‰ˆæœ¬
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_names.outputs.version_name }}
          body_path: ${{ steps.get_release_body.outputs.path }}
          draft: ${{ steps.determine_release_type.outputs.is_draft }}
          prerelease: ${{ steps.determine_release_type.outputs.is_prerelease }}
          files: |
            ${{ steps.find_apk.outputs.apk_path }}
            ${{ steps.find_mapping.outputs.mapping_path }}

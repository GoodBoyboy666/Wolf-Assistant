name: Android Release Publisher

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
jobs:
  build-and-release:
    name: Build and Release APK
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # è®¾ç½® Gradle ç¯å¢ƒ
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # æ„å»º Keystore
      - name: Decode Keystore
        id: decode_keystore
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 --decode > release.p12
          echo "âœ… Keystore decoded to ./release.p12"

      # è®¾ç½®æ‰§è¡Œæƒé™
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # è·å–é¡¹ç›®åä¸ç‰ˆæœ¬
      - name: Get project and version names
        id: get_names
        run: |
          echo "project_name=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
          echo "version_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      # å¼€å§‹æ„å»º
      - name: Build with Gradle
        run: ./gradlew assembleGithubActionRelease

      # æ‰¹é‡ç­¾åå¹¶é‡å‘½å
      - name: Sign and Rename APKs
        id: sign_apks
        run: |
          # æ‰¾åˆ°æ„å»ºå·¥å…·ä¸­çš„ apksigner
          ANDROID_BUILD_TOOLS_VERSION=$(ls $ANDROID_SDK_ROOT/build-tools/ | sort -V | tail -n 1)
          APKSIGNER="$ANDROID_SDK_ROOT/build-tools/$ANDROID_BUILD_TOOLS_VERSION/apksigner"

          # æœ€ç»ˆäº§ç‰©ç›®å½•
          mkdir -p release_artifacts

          # Gradle ç”Ÿæˆçš„æ‰€æœ‰æœªç­¾å APK ç›®å½•
          APK_DIR="app/build/outputs/apk/GitHubActionRelease"

          # éå†æ‰€æœ‰ unsigned apk
          find "$APK_DIR" -name "*-unsigned.apk" | while read INPUT_APK; do
            echo "----------------------------------------"
            echo "Processing: $INPUT_APK"

            # è§£æ ABI (æ¶æ„åç§°)
            if [[ "$INPUT_APK" == *"arm64-v8a"* ]]; then
              ABI="arm64-v8a"
            elif [[ "$INPUT_APK" == *"armeabi-v7a"* ]]; then
              ABI="armeabi-v7a"
            elif [[ "$INPUT_APK" == *"x86_64"* ]]; then
              ABI="x86_64"
            elif [[ "$INPUT_APK" == *"x86"* ]]; then
              ABI="x86"
            elif [[ "$INPUT_APK" == *"universal"* ]]; then
              ABI="universal"
            else
              ABI="unknown"
            fi

            echo "Detected ABI: $ABI"

            # æ„å»ºæœ€ç»ˆæ–‡ä»¶å: ProjectName-Version-ABI.apk
            NEW_FILENAME="${{ steps.get_names.outputs.project_name }}-${{ steps.get_names.outputs.version_name }}-$ABI.apk"
            OUTPUT_APK="release_artifacts/$NEW_FILENAME"

            echo "ğŸ” Signing $INPUT_APK with v3..."

            "$APKSIGNER" sign \
              --ks release.p12 \
              --ks-key-alias "${{ secrets.SIGNING_KEY_ALIAS }}" \
              --ks-pass "pass:${{ secrets.SIGNING_KEY_PASSWORD }}" \
              --lineage rotation/rotation.lineage \
              --v1-signing-enabled false \
              --v2-signing-enabled false \
              --v3-signing-enabled true \
              --min-sdk-version 28 \
              --rotation-min-sdk-version 28 \
              --out "$OUTPUT_APK" \
              "$INPUT_APK"
          done

          # éªŒè¯æ˜¯å¦æœ‰æ–‡ä»¶ç”Ÿæˆ
          if [ -z "$(ls -A release_artifacts)" ]; then
             echo "::error::No signed APKs were generated!"
             exit 1
          fi

          echo "âœ… Batch processing complete."

      # æŸ¥æ‰¾ Mapping æ–‡ä»¶
      - name: Find Mapping File
        id: find_mapping
        run: |
          MAPPING_DIR="app/build/outputs"
          MAPPING_PATH=$(find "$MAPPING_DIR" -type f -name "mapping.txt" | head -n 1)
          if [ ! -f "$MAPPING_PATH" ]; then
            echo "::warning::mapping.txt not found!"
            echo "mapping_path=" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found mapping file at $MAPPING_PATH"
            echo "mapping_path=$MAPPING_PATH" >> $GITHUB_OUTPUT
          fi

      # ç”Ÿæˆ Release å†…å®¹
      - name: Get Release Body from Git Commit
        id: get_release_body
        run: |
          git show -s --format=%B ${{ github.ref_name }} > release_notes.md
          echo "--- Release File Content Preview ---"
          cat release_notes.md
          echo "--- Release End of Preview ---"
          echo "path=release_notes.md" >> $GITHUB_OUTPUT

      # åˆ¤æ–­æ˜¯å¦ä¸ºéæ­£å¼ç‰ˆæœ¬
      - name: Determine Release Type
        id: determine_release_type
        run: |
          # æ£€æŸ¥ tag æ˜¯å¦åŒ…å« beta, rc, preview, alpha ç­‰å…³é”®å­—
          if [[ "${{ github.ref_name }}" == *"-beta"* || "${{ github.ref_name }}" == *"-rc"* || "${{ github.ref_name }}" == *"-preview"* || "${{ github.ref_name }}" == *"-alpha"* ]]; then
            echo "This is a pre-release."
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "is_draft=false" >> $GITHUB_OUTPUT
          else
            echo "This is a stable release."
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "is_draft=true" >> $GITHUB_OUTPUT
          fi

      # å‘å¸ƒç‰ˆæœ¬
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_names.outputs.version_name }}
          body_path: ${{ steps.get_release_body.outputs.path }}
          draft: ${{ steps.determine_release_type.outputs.is_draft }}
          prerelease: ${{ steps.determine_release_type.outputs.is_prerelease }}
          files: |
            release_artifacts/*.apk
            ${{ steps.find_mapping.outputs.mapping_path }}
